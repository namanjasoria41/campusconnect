{% extends "base.html" %}
{% block title %}Anonymous Gossip - CampusConnect{% endblock %}
{% block content %}

<div class="row">

  <!-- MAIN CONTENT (LEFT SIDE) -->
  <div class="col-lg-8">

    <!-- POST GOSSIP BOX -->
    <div class="glass-card mb-4">
      <h4 class="mb-2 feed-heading">Anonymous Gossips ðŸ‘€</h4>
      <p class="text-muted tiny mb-3">
        Share anything about campus life, fests, hostels, crushes, professors...
        Everything is posted <strong>anonymously</strong>. Be fun, not toxic.
      </p>

      <form method="post">
        <div class="mb-2">
          <textarea class="form-control" name="text" rows="3"
                    placeholder="What's the latest tea? â˜•"
                    required></textarea>
        </div>

        <div class="d-flex flex-wrap align-items-center gap-2">
          <label class="tiny text-muted mb-0">Category:</label>
          <select class="form-select form-select-sm w-auto" name="category">
            {% for cat in categories %}
              <option value="{{ cat }}">{{ cat|capitalize }}</option>
            {% endfor %}
          </select>

          <button class="btn btn-primary ms-auto">Post anonymously</button>
        </div>
      </form>
    </div>

    <!-- FILTER BAR -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">

      <!-- Category filter -->
      <div class="d-flex gap-2 flex-wrap">
        <a href="{{ url_for('gossip.feed', category='all', sort=current_sort) }}"
           class="badge rounded-pill 
                  {% if current_category=='all' %}bg-light text-dark{% else %}bg-secondary{% endif %}">
          All
        </a>

        {% for cat in categories %}
          <a href="{{ url_for('gossip.feed', category=cat, sort=current_sort) }}"
             class="badge rounded-pill 
                    {% if current_category==cat %}bg-light text-dark{% else %}bg-secondary{% endif %}">
            {{ cat|capitalize }}
          </a>
        {% endfor %}
      </div>

      <!-- Sorting dropdown -->
      <form method="get" class="d-flex align-items-center gap-1">
        <input type="hidden" name="category" value="{{ current_category }}">
        <label class="tiny text-muted mb-0">Sort by:</label>
        <select name="sort" class="form-select form-select-sm" onchange="this.form.submit()">
          <option value="latest" {% if current_sort=='latest' %}selected{% endif %}>Latest</option>
          <option value="top" {% if current_sort=='top' %}selected{% endif %}>Top</option>
          <option value="hot" {% if current_sort=='hot' %}selected{% endif %}>Hot</option>
        </select>
      </form>
    </div>

    <!-- GOSSIP LIST -->
    {% if gossips %}
      {% for g in gossips %}
        <div class="card glass-card mb-3">
          <div class="card-body">

            <!-- HEADER -->
            <div class="d-flex justify-content-between mb-2">
              <div>
                <strong>Anon</strong>
                <small class="text-muted ms-2">{{ g.category|capitalize }}</small>
              </div>

              <small class="text-muted tiny">
                {{ g.created_at.strftime('%d %b %Y %H:%M') }}
              </small>
            </div>

            <!-- GOSSIP TEXT -->
            <p class="mb-3 gossip-text">{{ g.text }}</p>

            <!-- VOTE + VIEW BUTTON -->
            <div class="d-flex justify-content-between align-items-center">

              <!-- Voting buttons -->
              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-outline-light gossip-vote-btn"
                        type="button"
                        data-id="{{ g.id }}" data-action="up">â–²</button>

                <span id="gossip-score-{{ g.id }}">
                  {{ g.upvotes - g.downvotes }}
                </span>

                <button class="btn btn-sm btn-outline-light gossip-vote-btn"
                        type="button"
                        data-id="{{ g.id }}" data-action="down">â–¼</button>
              </div>

              <!-- View full post -->
              <a href="{{ url_for('gossip.detail', gossip_id=g.id) }}"
                 class="btn btn-sm btn-outline-info">
                View & Comment
              </a>

            </div>

          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-muted">No gossips yet. Be the first to post ðŸ¤«</p>
    {% endif %}

  </div>

  <!-- SIDEBAR (RIGHT SIDE) -->
  <div class="col-lg-4 mt-4 mt-lg-0">

    <div class="glass-card">
      <h5 class="mb-2">Rules</h5>
      <ul class="small mb-0">
        <li>No real names / personal attacks.</li>
        <li>No harassment or hate speech.</li>
        <li>Admins can remove abusive content.</li>
      </ul>
    </div>

  </div>

</div>

<!-- VOTING SCRIPT -->
<script>
document.querySelectorAll(".gossip-vote-btn").forEach(btn => {
  btn.addEventListener("click", function() {
    const id = this.dataset.id;
    const action = this.dataset.action;

    fetch(`/gossip/vote/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: `action=${action}`
    })
    .then(res => res.json())
    .then(data => {
      if (data.ok) {
        document.getElementById(`gossip-score-${id}`).innerText = data.score;
      }
    })
    .catch(console.error);
  });
});
</script>

{% endblock %}

