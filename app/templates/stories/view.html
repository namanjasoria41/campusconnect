{% extends "base.html" %}
{% block title %}Stories - CampusConnect{% endblock %}
{% block content %}

{% set first_story = stories|first %}

<div class="story-viewer-container">

  {% if first_story %}
    {% set author = first_story.author %}

    <div class="story-viewer-card glass-card">

      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="d-flex align-items-center gap-2">
          {% if author.photo %}
            <img src="{{ url_for('static', filename='uploads/' ~ author.photo) }}" class="story-viewer-avatar">
          {% else %}
            <div class="story-viewer-avatar-placeholder">
              {{ author.name[0]|upper }}
            </div>
          {% endif %}
          <div>
            <strong>{{ author.name }}</strong><br>
            <small class="text-muted">Stories</small>
          </div>
        </div>

        <a href="{{ url_for('main.feed') }}" class="btn btn-sm btn-outline-light">Close</a>
      </div>

      <!-- Story Media -->
      <div class="story-viewer-main mb-3">
        <img id="story-media"
             src="{{ url_for('static', filename='uploads/' ~ first_story.media) }}"
             class="story-viewer-image">
      </div>

      <!-- Controls -->
      <div class="d-flex justify-content-between">
        <button class="btn btn-outline-light btn-sm" id="story-prev-btn">Prev</button>
        <button class="btn btn-outline-light btn-sm" id="story-next-btn">Next</button>
      </div>

    </div>

  {% else %}
    <div class="glass-card text-center">
      <p class="mb-0">No active stories.</p>
    </div>
  {% endif %}

</div>

{% if stories %}
<script>
// ---------------------------------------------------------
// Build clean JS array using tojson
// ---------------------------------------------------------
const storyMedia = {{ story_urls | tojson }};
let currentIndex = 0;

const imgEl = document.getElementById("story-media");
const prevBtn = document.getElementById("story-prev-btn");
const nextBtn = document.getElementById("story-next-btn");

// Update media
function updateStory() {
  imgEl.src = storyMedia[currentIndex];
}

// Prev
prevBtn.addEventListener("click", () => {
  if (currentIndex > 0) {
    currentIndex -= 1;
    updateStory();
  }
});

// Next
nextBtn.addEventListener("click", () => {
  if (currentIndex < storyMedia.length - 1) {
    currentIndex += 1;
    updateStory();
  }
});

// Auto-advance every 5s
let autoTimer = setInterval(() => {
  if (currentIndex < storyMedia.length - 1) {
    currentIndex += 1;
    updateStory();
  } else {
    clearInterval(autoTimer);
  }
}, 5000);
</script>
{% endif %}

{% endblock %}
